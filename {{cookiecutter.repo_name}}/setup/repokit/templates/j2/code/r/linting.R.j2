{% raw %}
#!/usr/bin/env Rscript
# Auto-generated from linting.R.j2

args <- commandArgs(trailingOnly = FALSE)
file_arg <- grep("^--file=", args, value = TRUE)
script_path <- if (length(file_arg)) substring(file_arg, 8) else normalizePath(".")
PROJECT_ROOT <- normalizePath(file.path(dirname(script_path), ".."), winslash = "/", mustWork = FALSE)
R_DIR <- normalizePath(file.path(PROJECT_ROOT, "R"), winslash = "/", mustWork = FALSE)

cat(sprintf("PROJECT_ROOT: %s\n", PROJECT_ROOT))
cat(sprintf("R_DIR: %s\n\n", R_DIR))

## --- renv activation (renv lives under R_DIR) ---
activate_path <- file.path(R_DIR, "renv", "activate.R")
if (file.exists(activate_path)) {
  cat("[renv] Activating project library in R_DIR...\n")
  old_wd <- getwd()
  on.exit(setwd(old_wd), add = TRUE)
  setwd(R_DIR)
  
  old_env <- Sys.getenv("RENV_PROJECT", unset = NA)
  on.exit({
    if (is.na(old_env)) Sys.unsetenv("RENV_PROJECT") else Sys.setenv(RENV_PROJECT = old_env)
  }, add = TRUE)
  Sys.setenv(RENV_PROJECT = R_DIR)
  
  source(activate_path, local = TRUE)
} else {
  cat("[renv] No renv project found in R_DIR; using default libraries.\n")
}
## -----------------------------------------------

if (!requireNamespace("lintr", quietly = TRUE)) {
  message('ERROR: lintr is not installed. In R (with renv active): renv::install("lintr")')
  quit(status = 2)
}

if (!dir.exists(R_DIR)) {
  message(sprintf("Info: R directory not found: %s (skipping)", R_DIR))
  quit(status = 0)
}

cat("[lintr] lint_dir()\n\n")
l <- lintr::lint_dir(path = R_DIR)
print(l)
quit(status = if (length(l) > 0) 1 else 0)

{% endraw %}